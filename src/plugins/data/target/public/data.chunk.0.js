(window["data_bundle_jsonpfunction"]=window["data_bundle_jsonpfunction"]||[]).push([[0],{214:function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__;
/*!
  Copyright (c) 2017 Jed Watson.
  Licensed under the MIT License (MIT), see
  http://jedwatson.github.io/classnames
*/(function(){"use strict";var hasOwn={}.hasOwnProperty;function classNames(){var classes=[];for(var i=0;i<arguments.length;i++){var arg=arguments[i];if(!arg)continue;var argType=typeof arg;if(argType==="string"||argType==="number"){classes.push(arg)}else if(Array.isArray(arg)&&arg.length){var inner=classNames.apply(null,arg);if(inner){classes.push(inner)}}else if(argType==="object"){for(var key in arg){if(hasOwn.call(arg,key)&&arg[key]){classes.push(key)}}}}return classes.join(" ")}if(true&&module.exports){classNames.default=classNames;module.exports=classNames}else if(true){!(__WEBPACK_AMD_DEFINE_ARRAY__=[],__WEBPACK_AMD_DEFINE_RESULT__=function(){return classNames}.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__),__WEBPACK_AMD_DEFINE_RESULT__!==undefined&&(module.exports=__WEBPACK_AMD_DEFINE_RESULT__))}else{}})()},216:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return METRIC_TYPE}));function wrapArray(subj){return Array.isArray(subj)?subj:[subj]}class UnreachableCaseError extends Error{constructor(val){super(`Unreachable case: ${val}`)}}function createUiCounterMetric({type:type,appName:appName,eventName:eventName,count:count=1}){return{type:type,appName:appName,eventName:eventName,count:count}}function trackUsageAgent(appName){const userAgent=window&&window.navigator&&window.navigator.userAgent||"";return{type:METRIC_TYPE.USER_AGENT,appName:appName,userAgent:userAgent}}var external_kbnSharedDeps_MomentTimezone_=__webpack_require__(37);var external_kbnSharedDeps_MomentTimezone_default=__webpack_require__.n(external_kbnSharedDeps_MomentTimezone_);function createApplicationUsageMetric(appId,viewId){return{type:METRIC_TYPE.APPLICATION_USAGE,appId:appId,viewId:viewId,startTime:external_kbnSharedDeps_MomentTimezone_default()(),numberOfClicks:0}}let METRIC_TYPE;(function(METRIC_TYPE){METRIC_TYPE["COUNT"]="count";METRIC_TYPE["LOADED"]="loaded";METRIC_TYPE["CLICK"]="click";METRIC_TYPE["USER_AGENT"]="user_agent";METRIC_TYPE["APPLICATION_USAGE"]="application_usage"})(METRIC_TYPE||(METRIC_TYPE={}));function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}class ReportStorageManager{constructor(storageKey,storage){_defineProperty(this,"storageKey",void 0);_defineProperty(this,"storage",void 0);this.storageKey=storageKey;this.storage=storage}get(){if(!this.storage)return;return this.storage.get(this.storageKey)}store(report){if(!this.storage)return;this.storage.set(this.storageKey,report)}}function application_usage_tracker_defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}class application_usage_tracker_ApplicationUsageTracker{constructor(reporter){application_usage_tracker_defineProperty(this,"trackedApplicationViews",{});application_usage_tracker_defineProperty(this,"reporter",void 0);application_usage_tracker_defineProperty(this,"currentAppId",void 0);application_usage_tracker_defineProperty(this,"currentApplicationKeys",[]);application_usage_tracker_defineProperty(this,"beforeUnloadListener",void 0);application_usage_tracker_defineProperty(this,"onVisiblityChangeListener",void 0);this.reporter=reporter}createKey(appId,viewId){return{appId:appId,viewId:viewId}}static serializeKey({appId:appId,viewId:viewId}){return`${appId}-${viewId}`}trackApplications(appKeys){for(const{appId:appId,viewId:viewId}of appKeys.filter(Boolean)){const serializedKey=application_usage_tracker_ApplicationUsageTracker.serializeKey({appId:appId,viewId:viewId});if(typeof this.trackedApplicationViews[serializedKey]!=="undefined"){continue}const metric=createApplicationUsageMetric(appId,viewId);this.trackedApplicationViews[serializedKey]=metric}}attachListeners(){if(typeof window==="undefined"||typeof document==="undefined"){return}this.beforeUnloadListener=()=>{this.flushTrackedViews()};this.onVisiblityChangeListener=()=>{if(document.visibilityState==="visible"){this.resumeTrackingAll()}else if(document.visibilityState==="hidden"){this.pauseTrackingAll()}};window.addEventListener("beforeunload",this.beforeUnloadListener);document.addEventListener("visibilitychange",this.onVisiblityChangeListener)}detachListeners(){if(typeof window==="undefined"||typeof document==="undefined"){return}if(this.beforeUnloadListener){window.removeEventListener("beforeunload",this.beforeUnloadListener)}if(this.onVisiblityChangeListener){document.removeEventListener("visibilitychange",this.onVisiblityChangeListener)}}sendMetricsToReporter(metrics){metrics.forEach(metric=>{this.reporter.reportApplicationUsage(metric)})}updateViewClickCounter(viewId){if(!this.currentAppId){return}const appKey=application_usage_tracker_ApplicationUsageTracker.serializeKey({appId:this.currentAppId,viewId:viewId});if(this.trackedApplicationViews[appKey]){this.trackedApplicationViews[appKey].numberOfClicks++}}flushTrackedViews(){const appViewMetrics=Object.values(this.trackedApplicationViews);this.sendMetricsToReporter(appViewMetrics);this.trackedApplicationViews={}}start(){this.attachListeners()}stop(){this.flushTrackedViews();this.detachListeners()}setCurrentAppId(appId){this.flushTrackedViews();this.currentAppId=appId}trackApplicationViewUsage(viewId){if(!this.currentAppId){return}const appKey=this.createKey(this.currentAppId,viewId);this.trackApplications([appKey])}pauseTrackingAll(){this.currentApplicationKeys=Object.values(this.trackedApplicationViews).map(({appId:appId,viewId:viewId})=>this.createKey(appId,viewId));this.flushTrackedViews()}resumeTrackingAll(){this.trackApplications(this.currentApplicationKeys);this.currentApplicationKeys=[];this.reporter.sendReports()}flushTrackedView(viewId){if(!this.currentAppId){return}const appKey=this.createKey(this.currentAppId,viewId);const serializedKey=application_usage_tracker_ApplicationUsageTracker.serializeKey(appKey);const appViewMetric=this.trackedApplicationViews[serializedKey];this.sendMetricsToReporter([appViewMetric]);delete this.trackedApplicationViews[serializedKey]}}function report_defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}const REPORT_VERSION=3;class report_ReportManager{constructor(report){report_defineProperty(this,"report",void 0);this.report=report||report_ReportManager.createReport()}static createReport(){return{reportVersion:REPORT_VERSION}}clearReport(){this.report=report_ReportManager.createReport()}isReportEmpty(){const{uiCounter:uiCounter,userAgent:userAgent,application_usage:appUsage}=this.report;const noUiCounters=!uiCounter||Object.keys(uiCounter).length===0;const noUserAgents=!userAgent||Object.keys(userAgent).length===0;const noAppUsage=!appUsage||Object.keys(appUsage).length===0;return noUiCounters&&noUserAgents&&noAppUsage}incrementTotal(count,currentTotal){const currentTotalNumber=typeof currentTotal==="number"?currentTotal:0;return count+currentTotalNumber}assignReports(newMetrics){wrapArray(newMetrics).forEach(newMetric=>this.assignReport(this.report,newMetric));return{report:this.report}}static createMetricKey(metric){switch(metric.type){case METRIC_TYPE.USER_AGENT:{const{appName:appName,type:type}=metric;return`${appName}-${type}`}case METRIC_TYPE.CLICK:case METRIC_TYPE.LOADED:case METRIC_TYPE.COUNT:{const{appName:appName,eventName:eventName,type:type}=metric;return`${appName}-${type}-${eventName}`}case METRIC_TYPE.APPLICATION_USAGE:{const{appId:appId,viewId:viewId}=metric;return application_usage_tracker_ApplicationUsageTracker.serializeKey({appId:appId,viewId:viewId})}default:throw new UnreachableCaseError(metric)}}assignReport(report,metric){const key=report_ReportManager.createMetricKey(metric);switch(metric.type){case METRIC_TYPE.USER_AGENT:{const{appName:appName,type:type,userAgent:userAgent}=metric;if(userAgent){report.userAgent={[key]:{key:key,appName:appName,type:type,userAgent:metric.userAgent}}}return}case METRIC_TYPE.CLICK:case METRIC_TYPE.LOADED:case METRIC_TYPE.COUNT:{var _report$uiCounter$key;const{appName:appName,type:type,eventName:eventName,count:count}=metric;report.uiCounter=report.uiCounter||{};const currentTotal=(_report$uiCounter$key=report.uiCounter[key])===null||_report$uiCounter$key===void 0?void 0:_report$uiCounter$key.total;report.uiCounter[key]={key:key,appName:appName,eventName:eventName,type:type,total:this.incrementTotal(count,currentTotal)};return}case METRIC_TYPE.APPLICATION_USAGE:{const{numberOfClicks:numberOfClicks,startTime:startTime,appId:appId,viewId:viewId}=metric;const minutesOnScreen=external_kbnSharedDeps_MomentTimezone_default()().diff(startTime,"minutes",true);report.application_usage=report.application_usage||{};const appExistingData=report.application_usage[key]||{minutesOnScreen:0,numberOfClicks:0,appId:appId,viewId:viewId};report.application_usage[key]={...appExistingData,minutesOnScreen:appExistingData.minutesOnScreen+minutesOnScreen,numberOfClicks:appExistingData.numberOfClicks+numberOfClicks};return}default:throw new UnreachableCaseError(metric)}}}report_defineProperty(report_ReportManager,"REPORT_VERSION",REPORT_VERSION);function reporter_defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}class reporter_Reporter{constructor(config){reporter_defineProperty(this,"checkInterval",void 0);reporter_defineProperty(this,"interval",void 0);reporter_defineProperty(this,"http",void 0);reporter_defineProperty(this,"reportManager",void 0);reporter_defineProperty(this,"storageManager",void 0);reporter_defineProperty(this,"debug",void 0);reporter_defineProperty(this,"retryCount",0);reporter_defineProperty(this,"maxRetries",3);reporter_defineProperty(this,"start",()=>{if(!this.interval){this.interval=setTimeout(()=>{this.interval=undefined;this.sendReports()},this.checkInterval)}});reporter_defineProperty(this,"reportUiCounter",(appName,type,eventNames,count)=>{const metrics=wrapArray(eventNames).map(eventName=>{this.log(`${type} Metric -> (${appName}:${eventName}):`);const report=createUiCounterMetric({type:type,appName:appName,eventName:eventName,count:count});this.log(report);return report});this.saveToReport(metrics)});reporter_defineProperty(this,"reportUserAgent",appName=>{this.log(`Reporting user-agent.`);const report=trackUsageAgent(appName);this.saveToReport([report])});reporter_defineProperty(this,"sendReports",async()=>{if(!this.reportManager.isReportEmpty()){try{await this.http(this.reportManager.report);this.flushReport()}catch(err){this.log(`Error Sending Metrics Report ${err}`);this.retryCount=this.retryCount+1;const versionMismatch=this.reportManager.report.reportVersion!==report_ReportManager.REPORT_VERSION;if(versionMismatch||this.retryCount>this.maxRetries){this.flushReport()}}}this.start()});const{http:http,storage:storage,debug:debug,checkInterval:checkInterval=9e4,storageKey:storageKey="analytics"}=config;this.http=http;this.checkInterval=checkInterval;this.storageManager=new ReportStorageManager(storageKey,storage);const storedReport=this.storageManager.get();this.reportManager=new report_ReportManager(storedReport);this.debug=!!debug}saveToReport(newMetrics){this.reportManager.assignReports(newMetrics);this.storageManager.store(this.reportManager.report)}flushReport(){this.retryCount=0;this.reportManager.clearReport();this.storageManager.store(this.reportManager.report)}log(message){if(this.debug){console.debug(message)}}reportApplicationUsage(appUsageReport){this.log(`Reporting application usage for ${appUsageReport.appId}, ${appUsageReport.viewId}`);this.saveToReport([appUsageReport])}}},218:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__.d(__webpack_exports__,"default",(function(){return query_string_input_QueryStringInputUI}));var external_kbnSharedDeps_React_=__webpack_require__(3);var external_kbnSharedDeps_React_default=__webpack_require__.n(external_kbnSharedDeps_React_);var external_kbnSharedDeps_KbnI18n_=__webpack_require__(0);var classnames=__webpack_require__(214);var classnames_default=__webpack_require__.n(classnames);var external_kbnSharedDeps_ElasticEui_=__webpack_require__(13);var external_kbnSharedDeps_KbnI18nReact_=__webpack_require__(44);var external_kbnSharedDeps_Lodash_=__webpack_require__(2);var web=__webpack_require__(216);var autocomplete=__webpack_require__(31);var public_=__webpack_require__(23);async function fetchIndexPatterns(indexPatternsService,indexPatternStrings){if(!indexPatternStrings||Object(external_kbnSharedDeps_Lodash_["isEmpty"])(indexPatternStrings)){return[]}const searchString=indexPatternStrings.map(string=>`"${string}"`).join(" | ");const exactMatches=(await indexPatternsService.find(searchString)).filter(ip=>indexPatternStrings.includes(ip.title));const allMatches=exactMatches.length===indexPatternStrings.length?exactMatches:[...exactMatches,await indexPatternsService.getDefault()];return allMatches}function QueryLanguageSwitcher(props){const kibana=Object(public_["useKibana"])();const kueryQuerySyntaxDocs=kibana.services.docLinks.links.query.kueryQuerySyntax;const[isPopoverOpen,setIsPopoverOpen]=Object(external_kbnSharedDeps_React_["useState"])(false);const luceneLabel=external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"data.query.queryBar.luceneLanguageName",defaultMessage:"Lucene"});const kqlLabel=external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"data.query.queryBar.kqlLanguageName",defaultMessage:"KQL"});const kqlFullName=external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"data.query.queryBar.kqlFullLanguageName",defaultMessage:"Kibana Query Language"});const button=external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiButtonEmpty"],{size:"xs",onClick:()=>setIsPopoverOpen(!isPopoverOpen),className:"euiFormControlLayout__append kqlQueryBar__languageSwitcherButton","data-test-subj":"switchQueryLanguageButton"},props.language==="lucene"?luceneLabel:kqlLabel);return external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiPopover"],{id:"queryLanguageSwitcherPopover",anchorClassName:"euiFormControlLayout__append",anchorPosition:props.anchorPosition||"downRight",button:button,isOpen:isPopoverOpen,closePopover:()=>setIsPopoverOpen(false),repositionOnScroll:true},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiPopoverTitle"],null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"data.query.queryBar.syntaxOptionsTitle",defaultMessage:"Syntax options"})),external_kbnSharedDeps_React_default.a.createElement("div",{style:{width:"350px"}},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiText"],null,external_kbnSharedDeps_React_default.a.createElement("p",null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"data.query.queryBar.syntaxOptionsDescription",defaultMessage:"The {docsLink} (KQL) offers a simplified query syntax and support for scripted fields. KQL also provides autocomplete if you have a Basic license or above. If you turn off KQL, Kibana uses Lucene.",values:{docsLink:external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiLink"],{href:kueryQuerySyntaxDocs,target:"_blank"},kqlFullName)}}))),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiSpacer"],{size:"m"}),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiForm"],null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiFormRow"],{label:kqlFullName},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiSwitch"],{id:"queryEnhancementOptIn",name:"popswitch",label:props.language==="kuery"?external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"data.query.queryBar.kqlOnLabel",defaultMessage:"On"}):external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"data.query.queryBar.kqlOffLabel",defaultMessage:"Off"}),checked:props.language==="kuery",onChange:()=>{const newLanguage=props.language==="lucene"?"kuery":"lucene";props.onSelectLanguage(newLanguage)},"data-test-subj":"languageToggle"})))))}var public_query=__webpack_require__(14);var ui=__webpack_require__(33);function _extends(){_extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};return _extends.apply(this,arguments)}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}const KEY_CODES={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,ESC:27,TAB:9,HOME:36,END:35};class query_string_input_QueryStringInputUI extends external_kbnSharedDeps_React_["Component"]{constructor(...args){var _this$services$usageC;super(...args);_defineProperty(this,"state",{isSuggestionsVisible:false,index:null,suggestions:[],suggestionLimit:50,selectionStart:null,selectionEnd:null,indexPatterns:[],queryBarRect:undefined});_defineProperty(this,"inputRef",null);_defineProperty(this,"persistedLog",void 0);_defineProperty(this,"abortController",void 0);_defineProperty(this,"fetchIndexPatternsAbortController",void 0);_defineProperty(this,"services",this.props.kibana.services);_defineProperty(this,"reportUiCounter",(_this$services$usageC=this.services.usageCollection)===null||_this$services$usageC===void 0?void 0:_this$services$usageC.reportUiCounter.bind(this.services.usageCollection,this.services.appName));_defineProperty(this,"componentIsUnmounting",false);_defineProperty(this,"queryBarInputDivRefInstance",Object(external_kbnSharedDeps_React_["createRef"])());_defineProperty(this,"getQueryString",()=>Object(public_query["A"])(this.props.query.query));_defineProperty(this,"fetchIndexPatterns",Object(external_kbnSharedDeps_Lodash_["debounce"])(async()=>{const stringPatterns=this.props.indexPatterns.filter(indexPattern=>typeof indexPattern==="string");const objectPatterns=this.props.indexPatterns.filter(indexPattern=>typeof indexPattern!=="string");if(this.fetchIndexPatternsAbortController)this.fetchIndexPatternsAbortController.abort();this.fetchIndexPatternsAbortController=new AbortController;const currentAbortController=this.fetchIndexPatternsAbortController;const objectPatternsFromStrings=await fetchIndexPatterns(this.services.data.indexPatterns,stringPatterns);if(!currentAbortController.signal.aborted){this.setState({indexPatterns:[...objectPatterns,...objectPatternsFromStrings]});this.updateSuggestions()}},200));_defineProperty(this,"getSuggestions",async()=>{if(!this.inputRef){return}const language=this.props.query.language;const queryString=this.getQueryString();const recentSearchSuggestions=this.getRecentSearchSuggestions(queryString);const hasQuerySuggestions=this.services.data.autocomplete.hasQuerySuggestions(language);if(!hasQuerySuggestions||!Array.isArray(this.state.indexPatterns)||Object(external_kbnSharedDeps_Lodash_["compact"])(this.state.indexPatterns).length===0){return recentSearchSuggestions}const indexPatterns=this.state.indexPatterns;const{selectionStart:selectionStart,selectionEnd:selectionEnd}=this.inputRef;if(selectionStart===null||selectionEnd===null){return}try{if(this.abortController)this.abortController.abort();this.abortController=new AbortController;const suggestions=await this.services.data.autocomplete.getQuerySuggestions({language:language,indexPatterns:indexPatterns,query:queryString,selectionStart:selectionStart,selectionEnd:selectionEnd,signal:this.abortController.signal})||[];return[...suggestions,...recentSearchSuggestions]}catch(e){var _this$reportUiCounter;if(e.message==="The user aborted a request.")return;(_this$reportUiCounter=this.reportUiCounter)===null||_this$reportUiCounter===void 0?void 0:_this$reportUiCounter.call(this,web["a"].LOADED,`query_string:suggestions_error`);throw e}});_defineProperty(this,"getRecentSearchSuggestions",query=>{if(!this.persistedLog){return[]}const recentSearches=this.persistedLog.get();const matchingRecentSearches=recentSearches.filter(recentQuery=>{const recentQueryString=typeof recentQuery==="object"?Object(public_query["A"])(recentQuery):recentQuery;return recentQueryString.includes(query)});return matchingRecentSearches.map(recentSearch=>{const text=Object(public_query["A"])(recentSearch);const start=0;const end=query.length;return{type:autocomplete["h"].RecentSearch,text:text,start:start,end:end}})});_defineProperty(this,"updateSuggestions",Object(external_kbnSharedDeps_Lodash_["debounce"])(async()=>{const suggestions=await this.getSuggestions()||[];if(!this.componentIsUnmounting){this.setState({suggestions:suggestions})}},100));_defineProperty(this,"onSubmit",query=>{if(this.props.onSubmit){if(this.persistedLog){this.persistedLog.add(query.query)}this.props.onSubmit({query:Object(public_query["s"])(query.query),language:query.language})}});_defineProperty(this,"onChange",query=>{this.updateSuggestions();if(this.props.onChange){this.props.onChange({query:Object(public_query["s"])(query.query),language:query.language})}});_defineProperty(this,"onQueryStringChange",value=>{this.setState({isSuggestionsVisible:true,index:null,suggestionLimit:50});this.onChange({query:value,language:this.props.query.language})});_defineProperty(this,"onInputChange",event=>{this.onQueryStringChange(event.target.value);if(event.target.value===""){this.handleRemoveHeight()}else{this.handleAutoHeight()}});_defineProperty(this,"onClickInput",event=>{if(event.target instanceof HTMLTextAreaElement){this.onQueryStringChange(event.target.value)}});_defineProperty(this,"onKeyUp",event=>{if([KEY_CODES.LEFT,KEY_CODES.RIGHT,KEY_CODES.HOME,KEY_CODES.END].includes(event.keyCode)){this.setState({isSuggestionsVisible:true});if(event.target instanceof HTMLTextAreaElement){this.onQueryStringChange(event.target.value)}}});_defineProperty(this,"onKeyDown",event=>{if(event.target instanceof HTMLTextAreaElement){const{isSuggestionsVisible:isSuggestionsVisible,index:index}=this.state;const preventDefault=event.preventDefault.bind(event);const{target:target,key:key,metaKey:metaKey}=event;const{value:value,selectionStart:selectionStart,selectionEnd:selectionEnd}=target;const updateQuery=(query,newSelectionStart,newSelectionEnd)=>{this.onQueryStringChange(query);this.setState({selectionStart:newSelectionStart,selectionEnd:newSelectionEnd})};switch(event.keyCode){case KEY_CODES.DOWN:if(isSuggestionsVisible&&index!==null){event.preventDefault();this.incrementIndex(index)}else if(isSuggestionsVisible&&index==null||this.getQueryString()===""){event.preventDefault();this.setState({isSuggestionsVisible:true,index:0})}break;case KEY_CODES.UP:if(isSuggestionsVisible&&index!==null){event.preventDefault();this.decrementIndex(index)}break;case KEY_CODES.ENTER:if(!this.props.bubbleSubmitEvent){event.preventDefault()}if(isSuggestionsVisible&&index!==null&&this.state.suggestions[index]){event.preventDefault();this.selectSuggestion(this.state.suggestions[index],index)}else{this.onSubmit(this.props.query);this.setState({isSuggestionsVisible:false})}break;case KEY_CODES.ESC:event.preventDefault();this.setState({isSuggestionsVisible:false,index:null});break;case KEY_CODES.TAB:this.setState({isSuggestionsVisible:false,index:null});break;default:if(selectionStart!==null&&selectionEnd!==null){Object(public_query["x"])({value:value,selectionStart:selectionStart,selectionEnd:selectionEnd,key:key,metaKey:metaKey,updateQuery:updateQuery,preventDefault:preventDefault})}break}}});_defineProperty(this,"selectSuggestion",(suggestion,listIndex)=>{var _this$reportUiCounter2,_this$reportUiCounter3;if(!this.inputRef){return}const{type:type,text:text,start:start,end:end,cursorIndex:cursorIndex}=suggestion;this.handleNestedFieldSyntaxNotification(suggestion);const query=this.getQueryString();const{selectionStart:selectionStart,selectionEnd:selectionEnd}=this.inputRef;if(selectionStart===null||selectionEnd===null){return}const value=query.substr(0,selectionStart)+query.substr(selectionEnd);const newQueryString=value.substr(0,start)+text+value.substr(end);(_this$reportUiCounter2=this.reportUiCounter)===null||_this$reportUiCounter2===void 0?void 0:_this$reportUiCounter2.call(this,web["a"].CLICK,`query_string:${type}:suggestions_select_position_${listIndex}`);(_this$reportUiCounter3=this.reportUiCounter)===null||_this$reportUiCounter3===void 0?void 0:_this$reportUiCounter3.call(this,web["a"].CLICK,`query_string:${type}:suggestions_select_q_length_${end-start}`);this.onQueryStringChange(newQueryString);this.setState({selectionStart:start+(cursorIndex?cursorIndex:text.length),selectionEnd:start+(cursorIndex?cursorIndex:text.length)});if(type===autocomplete["h"].RecentSearch){this.setState({isSuggestionsVisible:false,index:null});this.onSubmit({query:newQueryString,language:this.props.query.language})}});_defineProperty(this,"handleNestedFieldSyntaxNotification",suggestion=>{if("field"in suggestion&&suggestion.field.subType&&suggestion.field.subType.nested&&!this.services.storage.get("kibana.KQLNestedQuerySyntaxInfoOptOut")){const{notifications:notifications,docLinks:docLinks}=this.services;const onKQLNestedQuerySyntaxInfoOptOut=toast=>{if(!this.services.storage)return;this.services.storage.set("kibana.KQLNestedQuerySyntaxInfoOptOut",true);notifications.toasts.remove(toast)};if(notifications&&docLinks){const toast=notifications.toasts.add({title:external_kbnSharedDeps_KbnI18n_["i18n"].translate("data.query.queryBar.KQLNestedQuerySyntaxInfoTitle",{defaultMessage:"KQL nested query syntax"}),text:Object(public_["toMountPoint"])(external_kbnSharedDeps_React_default.a.createElement("div",null,external_kbnSharedDeps_React_default.a.createElement("p",null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"data.query.queryBar.KQLNestedQuerySyntaxInfoText",defaultMessage:"It looks like you're querying on a nested field. You can construct KQL syntax for nested queries in different ways, depending on the results you want. Learn more in our {link}.",values:{link:external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiLink"],{href:docLinks.links.query.kueryQuerySyntax,target:"_blank"},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"data.query.queryBar.KQLNestedQuerySyntaxInfoDocLinkText",defaultMessage:"docs"}))}})),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiFlexGroup"],{justifyContent:"flexEnd",gutterSize:"s"},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiFlexItem"],{grow:false},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiButton"],{size:"s",onClick:()=>onKQLNestedQuerySyntaxInfoOptOut(toast)},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"data.query.queryBar.KQLNestedQuerySyntaxInfoOptOutText",defaultMessage:"Don't show again"}))))))})}}});_defineProperty(this,"increaseLimit",()=>{this.setState({suggestionLimit:this.state.suggestionLimit+50})});_defineProperty(this,"incrementIndex",currentIndex=>{let nextIndex=currentIndex+1;if(currentIndex===null||nextIndex>=this.state.suggestions.length){nextIndex=0}this.setState({index:nextIndex})});_defineProperty(this,"decrementIndex",currentIndex=>{const previousIndex=currentIndex-1;if(previousIndex<0){this.setState({index:this.state.suggestions.length-1})}else{this.setState({index:previousIndex})}});_defineProperty(this,"onSelectLanguage",language=>{var _this$reportUiCounter4;this.services.http.post("/api/kibana/kql_opt_in_stats",{body:JSON.stringify({opt_in:language==="kuery"})});this.services.storage.set("kibana.userQueryLanguage",language);const newQuery={query:"",language:language};this.onChange(newQuery);this.onSubmit(newQuery);(_this$reportUiCounter4=this.reportUiCounter)===null||_this$reportUiCounter4===void 0?void 0:_this$reportUiCounter4.call(this,web["a"].LOADED,`query_string:language:${language}`)});_defineProperty(this,"onOutsideClick",()=>{if(this.state.isSuggestionsVisible){this.setState({isSuggestionsVisible:false,index:null})}this.handleBlurHeight();if(this.props.onChangeQueryInputFocus){this.props.onChangeQueryInputFocus(false)}});_defineProperty(this,"onInputBlur",()=>{this.handleBlurHeight();if(this.props.onChangeQueryInputFocus){this.props.onChangeQueryInputFocus(false)}if(Object(external_kbnSharedDeps_Lodash_["isFunction"])(this.props.onBlur)){this.props.onBlur()}});_defineProperty(this,"onClickSuggestion",(suggestion,index)=>{if(!this.inputRef){return}this.selectSuggestion(suggestion,index);this.inputRef.focus()});_defineProperty(this,"initPersistedLog",()=>{const{uiSettings:uiSettings,storage:storage,appName:appName}=this.services;this.persistedLog=this.props.persistedLog?this.props.persistedLog:Object(public_query["v"])(uiSettings,storage,appName,this.props.query.language)});_defineProperty(this,"onMouseEnterSuggestion",index=>{this.setState({index:index})});_defineProperty(this,"textareaId",Object(external_kbnSharedDeps_ElasticEui_["htmlIdGenerator"])()());_defineProperty(this,"handleListUpdate",()=>{var _this$queryBarInputDi;if(this.componentIsUnmounting)return;return this.setState({queryBarRect:(_this$queryBarInputDi=this.queryBarInputDivRefInstance.current)===null||_this$queryBarInputDi===void 0?void 0:_this$queryBarInputDi.getBoundingClientRect()})});_defineProperty(this,"handleAutoHeight",()=>{if(this.inputRef!==null&&document.activeElement===this.inputRef){this.inputRef.style.setProperty("height",`${this.inputRef.scrollHeight}px`,"important")}this.handleListUpdate()});_defineProperty(this,"handleRemoveHeight",()=>{if(this.inputRef!==null){this.inputRef.style.removeProperty("height")}});_defineProperty(this,"handleBlurHeight",()=>{if(this.inputRef!==null){this.handleRemoveHeight();this.inputRef.scrollTop=0}});_defineProperty(this,"handleOnFocus",()=>{if(this.props.onChangeQueryInputFocus){this.props.onChangeQueryInputFocus(true)}requestAnimationFrame(()=>{this.handleAutoHeight()})})}componentDidMount(){const parsedQuery=Object(public_query["s"])(Object(public_query["A"])(this.props.query.query));if(!Object(external_kbnSharedDeps_Lodash_["isEqual"])(this.props.query.query,parsedQuery)){this.onChange({...this.props.query,query:parsedQuery})}this.initPersistedLog();this.fetchIndexPatterns();this.handleListUpdate();window.addEventListener("resize",this.handleAutoHeight);window.addEventListener("scroll",this.handleListUpdate,{passive:true,capture:true})}componentDidUpdate(prevProps){const parsedQuery=Object(public_query["s"])(Object(public_query["A"])(this.props.query.query));if(!Object(external_kbnSharedDeps_Lodash_["isEqual"])(this.props.query.query,parsedQuery)){this.onChange({...this.props.query,query:parsedQuery})}this.initPersistedLog();if(!Object(external_kbnSharedDeps_Lodash_["isEqual"])(prevProps.indexPatterns,this.props.indexPatterns)){this.fetchIndexPatterns()}else if(!Object(external_kbnSharedDeps_Lodash_["isEqual"])(prevProps.query,this.props.query)){this.updateSuggestions()}if(this.state.selectionStart!==null&&this.state.selectionEnd!==null){if(this.inputRef!=null){this.inputRef.setSelectionRange(this.state.selectionStart,this.state.selectionEnd)}this.setState({selectionStart:null,selectionEnd:null});if(document.activeElement!==null&&document.activeElement.id===this.textareaId){this.handleAutoHeight()}else{this.handleRemoveHeight()}}}componentWillUnmount(){if(this.abortController)this.abortController.abort();if(this.updateSuggestions.cancel)this.updateSuggestions.cancel();this.componentIsUnmounting=true;window.removeEventListener("resize",this.handleAutoHeight);window.removeEventListener("scroll",this.handleListUpdate,{capture:true})}render(){const isSuggestionsVisible=this.state.isSuggestionsVisible&&{"aria-controls":"kbnTypeahead__items","aria-owns":"kbnTypeahead__items"};const ariaCombobox={...isSuggestionsVisible,role:"combobox"};const containerClassName=classnames_default()("euiFormControlLayout euiFormControlLayout--group kbnQueryBar__wrap",this.props.className);const inputClassName=classnames_default()("kbnQueryBar__textarea",this.props.iconType?"kbnQueryBar__textarea--withIcon":null);return external_kbnSharedDeps_React_default.a.createElement("div",{className:containerClassName},this.props.prepend,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiOutsideClickDetector"],{onOutsideClick:this.onOutsideClick},external_kbnSharedDeps_React_default.a.createElement("div",_extends({},ariaCombobox,{style:{position:"relative",width:"100%"},"aria-label":external_kbnSharedDeps_KbnI18n_["i18n"].translate("data.query.queryBar.comboboxAriaLabel",{defaultMessage:"Search and filter the {pageType} page",values:{pageType:this.services.appName}}),"aria-haspopup":"true","aria-expanded":this.state.isSuggestionsVisible,"data-skip-axe":"aria-required-children"}),external_kbnSharedDeps_React_default.a.createElement("div",{role:"search",className:"euiFormControlLayout__childrenWrapper kbnQueryBar__textareaWrap",ref:this.queryBarInputDivRefInstance},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiTextArea"],{placeholder:this.props.placeholder||external_kbnSharedDeps_KbnI18n_["i18n"].translate("data.query.queryBar.searchInputPlaceholder",{defaultMessage:"Search"}),value:this.getQueryString(),onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onChange:this.onInputChange,onClick:this.onClickInput,onBlur:this.onInputBlur,onFocus:this.handleOnFocus,className:inputClassName,fullWidth:true,rows:1,id:this.textareaId,autoFocus:this.props.onChangeQueryInputFocus?false:!this.props.disableAutoFocus,inputRef:node=>{if(node){this.inputRef=node}},autoComplete:"off",spellCheck:false,"aria-label":external_kbnSharedDeps_KbnI18n_["i18n"].translate("data.query.queryBar.searchInputAriaLabel",{defaultMessage:"Start typing to search and filter the {pageType} page",values:{pageType:this.services.appName}}),"aria-autocomplete":"list","aria-controls":this.state.isSuggestionsVisible?"kbnTypeahead__items":undefined,"aria-activedescendant":this.state.isSuggestionsVisible&&typeof this.state.index==="number"?`suggestion-${this.state.index}`:undefined,role:"textbox","data-test-subj":this.props.dataTestSubj||"queryInput",isInvalid:this.props.isInvalid},this.getQueryString()),this.props.iconType?external_kbnSharedDeps_React_default.a.createElement("div",{className:"euiFormControlLayoutIcons"},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiIcon"],{className:"euiFormControlLayoutCustomIcon__icon","aria-hidden":"true",type:"search"})):null),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiPortal"],null,external_kbnSharedDeps_React_default.a.createElement(ui["h"],{show:this.state.isSuggestionsVisible,suggestions:this.state.suggestions.slice(0,this.state.suggestionLimit),index:this.state.index,onClick:this.onClickSuggestion,onMouseEnter:this.onMouseEnterSuggestion,loadMore:this.increaseLimit,queryBarRect:this.state.queryBarRect,size:this.props.size})))),this.props.disableLanguageSwitcher?null:external_kbnSharedDeps_React_default.a.createElement(QueryLanguageSwitcher,{language:this.props.query.language,anchorPosition:this.props.languageSwitcherPopoverAnchorPosition,onSelectLanguage:this.onSelectLanguage}))}}}}]);