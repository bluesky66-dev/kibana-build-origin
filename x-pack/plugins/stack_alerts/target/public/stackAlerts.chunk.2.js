/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window["stackAlerts_bundle_jsonpfunction"]=window["stackAlerts_bundle_jsonpfunction"]||[]).push([[2],{19:function(module,exports,__webpack_require__){"use strict";var isOldIE=function isOldIE(){var memo;return function memorize(){if(typeof memo==="undefined"){memo=Boolean(window&&document&&document.all&&!window.atob)}return memo}}();var getTarget=function getTarget(){var memo={};return function memorize(target){if(typeof memo[target]==="undefined"){var styleTarget=document.querySelector(target);if(window.HTMLIFrameElement&&styleTarget instanceof window.HTMLIFrameElement){try{styleTarget=styleTarget.contentDocument.head}catch(e){styleTarget=null}}memo[target]=styleTarget}return memo[target]}}();var stylesInDom=[];function getIndexByIdentifier(identifier){var result=-1;for(var i=0;i<stylesInDom.length;i++){if(stylesInDom[i].identifier===identifier){result=i;break}}return result}function modulesToDom(list,options){var idCountMap={};var identifiers=[];for(var i=0;i<list.length;i++){var item=list[i];var id=options.base?item[0]+options.base:item[0];var count=idCountMap[id]||0;var identifier="".concat(id," ").concat(count);idCountMap[id]=count+1;var index=getIndexByIdentifier(identifier);var obj={css:item[1],media:item[2],sourceMap:item[3]};if(index!==-1){stylesInDom[index].references++;stylesInDom[index].updater(obj)}else{stylesInDom.push({identifier:identifier,updater:addStyle(obj,options),references:1})}identifiers.push(identifier)}return identifiers}function insertStyleElement(options){var style=document.createElement("style");var attributes=options.attributes||{};if(typeof attributes.nonce==="undefined"){var nonce=true?__webpack_require__.nc:undefined;if(nonce){attributes.nonce=nonce}}Object.keys(attributes).forEach((function(key){style.setAttribute(key,attributes[key])}));if(typeof options.insert==="function"){options.insert(style)}else{var target=getTarget(options.insert||"head");if(!target){throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.")}target.appendChild(style)}return style}function removeStyleElement(style){if(style.parentNode===null){return false}style.parentNode.removeChild(style)}var replaceText=function replaceText(){var textStore=[];return function replace(index,replacement){textStore[index]=replacement;return textStore.filter(Boolean).join("\n")}}();function applyToSingletonTag(style,index,remove,obj){var css=remove?"":obj.media?"@media ".concat(obj.media," {").concat(obj.css,"}"):obj.css;if(style.styleSheet){style.styleSheet.cssText=replaceText(index,css)}else{var cssNode=document.createTextNode(css);var childNodes=style.childNodes;if(childNodes[index]){style.removeChild(childNodes[index])}if(childNodes.length){style.insertBefore(cssNode,childNodes[index])}else{style.appendChild(cssNode)}}}function applyToTag(style,options,obj){var css=obj.css;var media=obj.media;var sourceMap=obj.sourceMap;if(media){style.setAttribute("media",media)}else{style.removeAttribute("media")}if(sourceMap&&btoa){css+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(sourceMap))))," */")}if(style.styleSheet){style.styleSheet.cssText=css}else{while(style.firstChild){style.removeChild(style.firstChild)}style.appendChild(document.createTextNode(css))}}var singleton=null;var singletonCounter=0;function addStyle(obj,options){var style;var update;var remove;if(options.singleton){var styleIndex=singletonCounter++;style=singleton||(singleton=insertStyleElement(options));update=applyToSingletonTag.bind(null,style,styleIndex,false);remove=applyToSingletonTag.bind(null,style,styleIndex,true)}else{style=insertStyleElement(options);update=applyToTag.bind(null,style,options);remove=function remove(){removeStyleElement(style)}}update(obj);return function updateStyle(newObj){if(newObj){if(newObj.css===obj.css&&newObj.media===obj.media&&newObj.sourceMap===obj.sourceMap){return}update(obj=newObj)}else{remove()}}}module.exports=function(list,options){options=options||{};if(!options.singleton&&typeof options.singleton!=="boolean"){options.singleton=isOldIE()}list=list||[];var lastIdentifiers=modulesToDom(list,options);return function update(newList){newList=newList||[];if(Object.prototype.toString.call(newList)!=="[object Array]"){return}for(var i=0;i<lastIdentifiers.length;i++){var identifier=lastIdentifiers[i];var index=getIndexByIdentifier(identifier);stylesInDom[index].references--}var newLastIdentifiers=modulesToDom(newList,options);for(var _i=0;_i<lastIdentifiers.length;_i++){var _identifier=lastIdentifiers[_i];var _index=getIndexByIdentifier(_identifier);if(stylesInDom[_index].references===0){stylesInDom[_index].updater();stylesInDom.splice(_index,1)}}lastIdentifiers=newLastIdentifiers}}},20:function(module,exports,__webpack_require__){"use strict";module.exports=function(useSourceMap){var list=[];list.toString=function toString(){return this.map((function(item){var content=cssWithMappingToString(item,useSourceMap);if(item[2]){return"@media ".concat(item[2]," {").concat(content,"}")}return content})).join("")};list.i=function(modules,mediaQuery,dedupe){if(typeof modules==="string"){modules=[[null,modules,""]]}var alreadyImportedModules={};if(dedupe){for(var i=0;i<this.length;i++){var id=this[i][0];if(id!=null){alreadyImportedModules[id]=true}}}for(var _i=0;_i<modules.length;_i++){var item=[].concat(modules[_i]);if(dedupe&&alreadyImportedModules[item[0]]){continue}if(mediaQuery){if(!item[2]){item[2]=mediaQuery}else{item[2]="".concat(mediaQuery," and ").concat(item[2])}}list.push(item)}};return list};function cssWithMappingToString(item,useSourceMap){var content=item[1]||"";var cssMapping=item[3];if(!cssMapping){return content}if(useSourceMap&&typeof btoa==="function"){var sourceMapping=toComment(cssMapping);var sourceURLs=cssMapping.sources.map((function(source){return"/*# sourceURL=".concat(cssMapping.sourceRoot||"").concat(source," */")}));return[content].concat(sourceURLs).concat([sourceMapping]).join("\n")}return[content].join("\n")}function toComment(sourceMap){var base64=btoa(unescape(encodeURIComponent(JSON.stringify(sourceMap))));var data="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(base64);return"/*# ".concat(data," */")}},22:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return IndexSelectPopover}));var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2);var react__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(react__WEBPACK_IMPORTED_MODULE_0__);var _kbn_i18n__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(0);var _kbn_i18n__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_kbn_i18n__WEBPACK_IMPORTED_MODULE_1__);var lodash__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(10);var lodash__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(lodash__WEBPACK_IMPORTED_MODULE_2__);var _kbn_i18n_react__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(8);var _kbn_i18n_react__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_kbn_i18n_react__WEBPACK_IMPORTED_MODULE_3__);var _elastic_eui__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(7);var _elastic_eui__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(_elastic_eui__WEBPACK_IMPORTED_MODULE_4__);var _src_plugins_kibana_react_public__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(9);var _src_plugins_kibana_react_public__WEBPACK_IMPORTED_MODULE_5___default=__webpack_require__.n(_src_plugins_kibana_react_public__WEBPACK_IMPORTED_MODULE_5__);var _triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(1);var _triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6___default=__webpack_require__.n(_triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6__);const IndexSelectPopover=({index:index,esFields:esFields,timeField:timeField,errors:errors,onIndexChange:onIndexChange,onTimeFieldChange:onTimeFieldChange})=>{const{http:http}=Object(_src_plugins_kibana_react_public__WEBPACK_IMPORTED_MODULE_5__["useKibana"])().services;const[indexPopoverOpen,setIndexPopoverOpen]=Object(react__WEBPACK_IMPORTED_MODULE_0__["useState"])(false);const[indexOptions,setIndexOptions]=Object(react__WEBPACK_IMPORTED_MODULE_0__["useState"])([]);const[indexPatterns,setIndexPatterns]=Object(react__WEBPACK_IMPORTED_MODULE_0__["useState"])([]);const[areIndicesLoading,setAreIndicesLoading]=Object(react__WEBPACK_IMPORTED_MODULE_0__["useState"])(false);const[timeFieldOptions,setTimeFieldOptions]=Object(react__WEBPACK_IMPORTED_MODULE_0__["useState"])([_triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6__["firstFieldOption"]]);Object(react__WEBPACK_IMPORTED_MODULE_0__["useEffect"])(()=>{const indexPatternsFunction=async()=>{setIndexPatterns(await Object(_triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6__["getIndexPatterns"])())};indexPatternsFunction()},[]);Object(react__WEBPACK_IMPORTED_MODULE_0__["useEffect"])(()=>{const timeFields=Object(_triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6__["getTimeFieldOptions"])(esFields);setTimeFieldOptions([_triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6__["firstFieldOption"],...timeFields])},[esFields]);const renderIndices=indices=>{const rows=indices.map((indexName,idx)=>react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement("p",{key:idx},indexName,idx<indices.length-1?",":null));return react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement("div",null,rows)};const closeIndexPopover=()=>{setIndexPopoverOpen(false);if(timeField===undefined){onTimeFieldChange("")}};return react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_elastic_eui__WEBPACK_IMPORTED_MODULE_4__["EuiPopover"],{id:"indexPopover",button:react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_elastic_eui__WEBPACK_IMPORTED_MODULE_4__["EuiExpression"],{display:"columns","data-test-subj":"selectIndexExpression",description:_kbn_i18n__WEBPACK_IMPORTED_MODULE_1__["i18n"].translate("xpack.stackAlerts.components.ui.alertParams.indexLabel",{defaultMessage:"index"}),value:index&&index.length>0?renderIndices(index):_triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6__["firstFieldOption"].text,isActive:indexPopoverOpen,onClick:()=>{setIndexPopoverOpen(true)},isInvalid:!(index&&index.length>0&&timeField!=="")}),isOpen:indexPopoverOpen,closePopover:closeIndexPopover,ownFocus:true,anchorPosition:"downLeft",zIndex:8e3,display:"block"},react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement("div",{style:{width:"450px"}},react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_elastic_eui__WEBPACK_IMPORTED_MODULE_4__["EuiPopoverTitle"],null,react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_elastic_eui__WEBPACK_IMPORTED_MODULE_4__["EuiFlexGroup"],{alignItems:"center",gutterSize:"s"},react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_elastic_eui__WEBPACK_IMPORTED_MODULE_4__["EuiFlexItem"],null,_kbn_i18n__WEBPACK_IMPORTED_MODULE_1__["i18n"].translate("xpack.stackAlerts.components.ui.alertParams.indexButtonLabel",{defaultMessage:"index"})),react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_elastic_eui__WEBPACK_IMPORTED_MODULE_4__["EuiFlexItem"],{grow:false},react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_elastic_eui__WEBPACK_IMPORTED_MODULE_4__["EuiButtonIcon"],{"data-test-subj":"closePopover",iconType:"cross",color:"danger","aria-label":_kbn_i18n__WEBPACK_IMPORTED_MODULE_1__["i18n"].translate("xpack.stackAlerts.components.ui.alertParams.closeIndexPopoverLabel",{defaultMessage:"Close"}),onClick:closeIndexPopover})))),react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_elastic_eui__WEBPACK_IMPORTED_MODULE_4__["EuiFormRow"],{id:"indexSelectSearchBox",fullWidth:true,label:react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_kbn_i18n_react__WEBPACK_IMPORTED_MODULE_3__["FormattedMessage"],{id:"xpack.stackAlerts.components.ui.alertParams.indicesToQueryLabel",defaultMessage:"Indices to query"}),isInvalid:errors.index.length>0&&index!=null&&index.length>0,error:errors.index,helpText:react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_kbn_i18n_react__WEBPACK_IMPORTED_MODULE_3__["FormattedMessage"],{id:"xpack.stackAlerts.components.ui.alertParams.howToBroadenSearchQueryDescription",defaultMessage:"Use * to broaden your query."})},react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_elastic_eui__WEBPACK_IMPORTED_MODULE_4__["EuiComboBox"],{fullWidth:true,async:true,isLoading:areIndicesLoading,isInvalid:errors.index.length>0&&index!=null&&index.length>0,noSuggestions:!indexOptions.length,options:indexOptions,"data-test-subj":"thresholdIndexesComboBox",selectedOptions:(index||[]).map(anIndex=>({label:anIndex,value:anIndex})),onChange:async selected=>{const selectedIndices=selected.map(aSelected=>aSelected.value).filter(lodash__WEBPACK_IMPORTED_MODULE_2__["isString"]);onIndexChange(selectedIndices);if(selectedIndices.length===0){setTimeFieldOptions([_triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6__["firstFieldOption"]])}else{const currentEsFields=await Object(_triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6__["getFields"])(http,selectedIndices);const timeFields=Object(_triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6__["getTimeFieldOptions"])(currentEsFields);setTimeFieldOptions([_triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6__["firstFieldOption"],...timeFields])}},onSearchChange:async search=>{setAreIndicesLoading(true);setIndexOptions(await Object(_triggers_actions_ui_public__WEBPACK_IMPORTED_MODULE_6__["getIndexOptions"])(http,search,indexPatterns));setAreIndicesLoading(false)},onBlur:()=>{if(!index){onIndexChange([])}}})),react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_elastic_eui__WEBPACK_IMPORTED_MODULE_4__["EuiFormRow"],{id:"thresholdTimeField",fullWidth:true,label:react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_kbn_i18n_react__WEBPACK_IMPORTED_MODULE_3__["FormattedMessage"],{id:"xpack.stackAlerts.components.ui.alertParams.timeFieldLabel",defaultMessage:"Time field"}),isInvalid:errors.timeField.length>0&&timeField!==undefined,error:errors.timeField},react__WEBPACK_IMPORTED_MODULE_0___default.a.createElement(_elastic_eui__WEBPACK_IMPORTED_MODULE_4__["EuiSelect"],{options:timeFieldOptions,isInvalid:errors.timeField.length>0&&timeField!==undefined,fullWidth:true,name:"thresholdTimeField","data-test-subj":"thresholdAlertTimeFieldSelect",value:timeField||"",onChange:e=>{onTimeFieldChange(e.target.value)},onBlur:()=>{if(timeField===undefined){onTimeFieldChange("")}}}))))}},27:function(module,exports,__webpack_require__){switch(window.__kbnThemeTag__){case"v7dark":return __webpack_require__(28);case"v7light":return __webpack_require__(30);case"v8dark":return __webpack_require__(32);case"v8light":return __webpack_require__(34)}},28:function(module,exports,__webpack_require__){var api=__webpack_require__(19);var content=__webpack_require__(29);content=content.__esModule?content.default:content;if(typeof content==="string"){content=[[module.i,content,""]]}var options={};options.insert="head";options.singleton=false;var update=api(content,options);module.exports=content.locals||{}},29:function(module,exports,__webpack_require__){var ___CSS_LOADER_API_IMPORT___=__webpack_require__(20);exports=___CSS_LOADER_API_IMPORT___(false);exports.push([module.i,".actAlertVisualization__chart {\n  height: 224px; }\n",""]);module.exports=exports},30:function(module,exports,__webpack_require__){var api=__webpack_require__(19);var content=__webpack_require__(31);content=content.__esModule?content.default:content;if(typeof content==="string"){content=[[module.i,content,""]]}var options={};options.insert="head";options.singleton=false;var update=api(content,options);module.exports=content.locals||{}},31:function(module,exports,__webpack_require__){var ___CSS_LOADER_API_IMPORT___=__webpack_require__(20);exports=___CSS_LOADER_API_IMPORT___(false);exports.push([module.i,".actAlertVisualization__chart {\n  height: 224px; }\n",""]);module.exports=exports},32:function(module,exports,__webpack_require__){var api=__webpack_require__(19);var content=__webpack_require__(33);content=content.__esModule?content.default:content;if(typeof content==="string"){content=[[module.i,content,""]]}var options={};options.insert="head";options.singleton=false;var update=api(content,options);module.exports=content.locals||{}},33:function(module,exports,__webpack_require__){var ___CSS_LOADER_API_IMPORT___=__webpack_require__(20);exports=___CSS_LOADER_API_IMPORT___(false);exports.push([module.i,".actAlertVisualization__chart {\n  height: 224px; }\n",""]);module.exports=exports},34:function(module,exports,__webpack_require__){var api=__webpack_require__(19);var content=__webpack_require__(35);content=content.__esModule?content.default:content;if(typeof content==="string"){content=[[module.i,content,""]]}var options={};options.insert="head";options.singleton=false;var update=api(content,options);module.exports=content.locals||{}},35:function(module,exports,__webpack_require__){var ___CSS_LOADER_API_IMPORT___=__webpack_require__(20);exports=___CSS_LOADER_API_IMPORT___(false);exports.push([module.i,".actAlertVisualization__chart {\n  height: 224px; }\n",""]);module.exports=exports},47:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__.d(__webpack_exports__,"DEFAULT_VALUES",(function(){return DEFAULT_VALUES}));__webpack_require__.d(__webpack_exports__,"IndexThresholdAlertTypeExpression",(function(){return IndexThresholdAlertTypeExpression}));__webpack_require__.d(__webpack_exports__,"default",(function(){return IndexThresholdAlertTypeExpression}));var external_kbnSharedDeps_React_=__webpack_require__(2);var external_kbnSharedDeps_React_default=__webpack_require__.n(external_kbnSharedDeps_React_);var external_kbnSharedDeps_KbnI18n_=__webpack_require__(0);var external_kbnSharedDeps_KbnI18nReact_=__webpack_require__(8);var external_kbnSharedDeps_ElasticEui_=__webpack_require__(7);var public_=__webpack_require__(9);var triggersActionsUi_public_=__webpack_require__(1);var external_kbnSharedDeps_Rxjs_=__webpack_require__(13);var external_kbnSharedDeps_ElasticCharts_=__webpack_require__(14);var external_kbnSharedDeps_MomentTimezone_=__webpack_require__(15);var external_kbnSharedDeps_MomentTimezone_default=__webpack_require__.n(external_kbnSharedDeps_MomentTimezone_);const INDEX_THRESHOLD_DATA_API_ROOT="/api/triggers_actions_ui/data";async function getThresholdAlertVisualizationData({model:model,visualizeOptions:visualizeOptions,http:http}){const timeSeriesQueryParams={index:model.index,timeField:model.timeField,aggType:model.aggType,aggField:model.aggField,groupBy:model.groupBy,termField:model.termField,termSize:model.termSize,timeWindowSize:model.timeWindowSize,timeWindowUnit:model.timeWindowUnit,dateStart:new Date(visualizeOptions.rangeFrom).toISOString(),dateEnd:new Date(visualizeOptions.rangeTo).toISOString(),interval:visualizeOptions.interval};return await http.post(`${INDEX_THRESHOLD_DATA_API_ROOT}/_time_series_query`,{body:JSON.stringify(timeSeriesQueryParams)})}var parse_duration_=__webpack_require__(16);const customTheme=()=>({lineSeriesStyle:{line:{strokeWidth:3},point:{visible:false}}});const getTimezone=uiSettings=>{const config=uiSettings;const DATE_FORMAT_CONFIG_KEY="dateFormat:tz";const isCustomTimezone=!config.isDefault(DATE_FORMAT_CONFIG_KEY);if(isCustomTimezone){return config.get(DATE_FORMAT_CONFIG_KEY)}const detectedTimezone=external_kbnSharedDeps_MomentTimezone_default.a.tz.guess();if(detectedTimezone){return detectedTimezone}const tzOffset=external_kbnSharedDeps_MomentTimezone_default()().format("Z");return tzOffset};const getDomain=(alertInterval,startAt)=>{const VISUALIZE_INTERVALS=30;let intervalMillis;try{intervalMillis=Object(parse_duration_["parseDuration"])(alertInterval)}catch(err){intervalMillis=1e3*60}return{min:startAt.getTime()-intervalMillis*VISUALIZE_INTERVALS,max:startAt.getTime()}};const DEFAULT_REFRESH_RATE=5e3;var LoadingStateType;(function(LoadingStateType){LoadingStateType[LoadingStateType["FirstLoad"]=0]="FirstLoad";LoadingStateType[LoadingStateType["Refresh"]=1]="Refresh";LoadingStateType[LoadingStateType["Idle"]=2]="Idle"})(LoadingStateType||(LoadingStateType={}));const ThresholdVisualization=({alertParams:alertParams,alertInterval:alertInterval,aggregationTypes:aggregationTypes,comparators:comparators,refreshRateInMilliseconds:refreshRateInMilliseconds=DEFAULT_REFRESH_RATE,charts:charts,dataFieldsFormats:dataFieldsFormats})=>{const{index:index,timeField:timeField,aggType:aggType,aggField:aggField,termSize:termSize,termField:termField,thresholdComparator:thresholdComparator,timeWindowSize:timeWindowSize,timeWindowUnit:timeWindowUnit,groupBy:groupBy,threshold:threshold}=alertParams;const{http:http,notifications:notifications,uiSettings:uiSettings}=Object(public_["useKibana"])().services;const[loadingState,setLoadingState]=Object(external_kbnSharedDeps_React_["useState"])(null);const[error,setError]=Object(external_kbnSharedDeps_React_["useState"])(undefined);const[visualizationData,setVisualizationData]=Object(external_kbnSharedDeps_React_["useState"])();const[startVisualizationAt,setStartVisualizationAt]=Object(external_kbnSharedDeps_React_["useState"])(new Date);Object(external_kbnSharedDeps_React_["useEffect"])(()=>{const source=Object(external_kbnSharedDeps_Rxjs_["interval"])(refreshRateInMilliseconds);const subscription=source.subscribe(val=>{setStartVisualizationAt(new Date)});return()=>{subscription.unsubscribe()}},[refreshRateInMilliseconds]);Object(external_kbnSharedDeps_React_["useEffect"])(()=>{(async()=>{try{setLoadingState(loadingState?LoadingStateType.Refresh:LoadingStateType.FirstLoad);setVisualizationData(await getVisualizationData(alertWithoutActions,visualizeOptions,http))}catch(e){if(notifications){notifications.toasts.addDanger({title:external_kbnSharedDeps_KbnI18n_["i18n"].translate("xpack.stackAlerts.threshold.ui.visualization.unableToLoadVisualizationMessage",{defaultMessage:"Unable to load visualization"})})}setError(e)}finally{setLoadingState(LoadingStateType.Idle)}})()},[index,timeField,aggType,aggField,termSize,termField,thresholdComparator,timeWindowSize,timeWindowUnit,groupBy,threshold,startVisualizationAt]);if(!charts||!uiSettings||!dataFieldsFormats){return null}const chartsTheme=charts.theme.useChartsTheme();const chartsBaseTheme=charts.theme.useChartsBaseTheme();const domain=getDomain(alertInterval,startVisualizationAt);const visualizeOptions={rangeFrom:new Date(domain.min).toISOString(),rangeTo:new Date(domain.max).toISOString(),interval:alertInterval};const alertWithoutActions={...alertParams,actions:[],type:"threshold"};if(loadingState===LoadingStateType.FirstLoad){return external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiEmptyPrompt"],{"data-test-subj":"firstLoad",title:external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiLoadingChart"],{size:"xl"}),body:external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiText"],{color:"subdued"},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"xpack.stackAlerts.threshold.ui.visualization.loadingAlertVisualizationDescription",defaultMessage:"Loading alert visualization…"}))})}if(error){return external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_React_["Fragment"],null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiSpacer"],{size:"l"}),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiCallOut"],{"data-test-subj":"errorCallout",title:external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"xpack.stackAlerts.threshold.ui.visualization.errorLoadingAlertVisualizationTitle",defaultMessage:"Cannot load alert visualization",values:{}}),color:"danger",iconType:"alert"},error))}const getThreshold=()=>thresholdComparator?threshold.slice(0,comparators[thresholdComparator].requiredValues):[];if(visualizationData){const alertVisualizationDataKeys=Object.keys(visualizationData);const timezone=getTimezone(uiSettings);const actualThreshold=getThreshold();let maxY=actualThreshold[actualThreshold.length-1];Object.values(visualizationData).forEach(data=>{data.forEach(([,y])=>{if(y>maxY){maxY=y}})});const dateFormatter=Object(external_kbnSharedDeps_ElasticCharts_["niceTimeFormatter"])([domain.min,domain.max]);const aggLabel=aggregationTypes[aggType].text;return external_kbnSharedDeps_React_default.a.createElement("div",{"data-test-subj":"alertVisualizationChart",style:{position:"relative"}},loadingState===LoadingStateType.Refresh?external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiLoadingSpinner"],{size:"l",style:{position:"absolute",top:"8%",right:"5%"}}):external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_React_["Fragment"],null),alertVisualizationDataKeys.length?external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticCharts_["Chart"],{size:["100%",200],renderer:"canvas"},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticCharts_["Settings"],{theme:[customTheme(),chartsTheme],baseTheme:chartsBaseTheme,xDomain:domain,showLegend:!!termField,showLegendExtra:true,legendPosition:external_kbnSharedDeps_ElasticCharts_["Position"].Bottom}),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticCharts_["Axis"],{id:"bottom",position:external_kbnSharedDeps_ElasticCharts_["Position"].Bottom,showOverlappingTicks:true,tickFormat:dateFormatter}),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticCharts_["Axis"],{domain:{max:maxY},id:"left",title:aggLabel,position:external_kbnSharedDeps_ElasticCharts_["Position"].Left}),alertVisualizationDataKeys.map(key=>external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticCharts_["LineSeries"],{key:key,id:key,xScaleType:external_kbnSharedDeps_ElasticCharts_["ScaleType"].Time,yScaleType:external_kbnSharedDeps_ElasticCharts_["ScaleType"].Linear,data:visualizationData[key],xAccessor:0,yAccessors:[1],timeZone:timezone})),actualThreshold.map((_value,thresholdIndex)=>{const specId=thresholdIndex===0?"threshold":`threshold${thresholdIndex}`;return external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticCharts_["LineAnnotation"],{key:specId,id:specId,domainType:external_kbnSharedDeps_ElasticCharts_["AnnotationDomainTypes"].YDomain,dataValues:[{dataValue:threshold[thresholdIndex],details:specId}]})})):external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiCallOut"],{"data-test-subj":"noDataCallout",size:"s",title:external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"xpack.stackAlerts.threshold.ui.visualization.thresholdPreviewChart.noDataTitle",defaultMessage:"No data matches this query"}),color:"warning"},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"xpack.stackAlerts.threshold.ui.visualization.thresholdPreviewChart.dataDoesNotExistTextMessage",defaultMessage:"Check that your time range and filters are correct."})))}return null};async function getVisualizationData(model,visualizeOptions,http){const vizData=await getThresholdAlertVisualizationData({model:model,visualizeOptions:visualizeOptions,http:http});const result={};for(const groupMetrics of vizData.results){result[groupMetrics.group]=groupMetrics.metrics.map(metricResult=>[Date.parse(metricResult[0]),metricResult[1]])}return result}var expression=__webpack_require__(27);var index_select_popover=__webpack_require__(22);const DEFAULT_VALUES={AGGREGATION_TYPE:"count",TERM_SIZE:5,THRESHOLD_COMPARATOR:triggersActionsUi_public_["COMPARATORS"].GREATER_THAN,TIME_WINDOW_SIZE:5,TIME_WINDOW_UNIT:"m",THRESHOLD:[1e3],GROUP_BY:"all"};const expressionFieldsWithValidation=["index","timeField","aggField","termSize","termField","threshold0","threshold1","timeWindowSize"];function isString(value){return typeof value==="string"}function indexParamToArray(index){if(!index)return[];return isString(index)?[index]:index}const IndexThresholdAlertTypeExpression=({alertParams:alertParams,alertInterval:alertInterval,setAlertParams:setAlertParams,setAlertProperty:setAlertProperty,errors:errors,charts:charts,data:data})=>{const{index:index,timeField:timeField,aggType:aggType,aggField:aggField,groupBy:groupBy,termSize:termSize,termField:termField,thresholdComparator:thresholdComparator,threshold:threshold,timeWindowSize:timeWindowSize,timeWindowUnit:timeWindowUnit}=alertParams;const indexArray=indexParamToArray(index);const{http:http}=Object(public_["useKibana"])().services;const[esFields,setEsFields]=Object(external_kbnSharedDeps_React_["useState"])([]);const hasExpressionErrors=!!Object.keys(errors).find(errorKey=>expressionFieldsWithValidation.includes(errorKey)&&errors[errorKey].length>=1&&alertParams[errorKey]!==undefined);const cannotShowVisualization=!!Object.keys(errors).find(errorKey=>expressionFieldsWithValidation.includes(errorKey)&&errors[errorKey].length>=1);const expressionErrorMessage=external_kbnSharedDeps_KbnI18n_["i18n"].translate("xpack.stackAlerts.threshold.ui.alertParams.fixErrorInExpressionBelowValidationMessage",{defaultMessage:"Expression contains errors."});const setDefaultExpressionValues=async()=>{setAlertProperty("params",{...alertParams,aggType:aggType!==null&&aggType!==void 0?aggType:DEFAULT_VALUES.AGGREGATION_TYPE,termSize:termSize!==null&&termSize!==void 0?termSize:DEFAULT_VALUES.TERM_SIZE,thresholdComparator:thresholdComparator!==null&&thresholdComparator!==void 0?thresholdComparator:DEFAULT_VALUES.THRESHOLD_COMPARATOR,timeWindowSize:timeWindowSize!==null&&timeWindowSize!==void 0?timeWindowSize:DEFAULT_VALUES.TIME_WINDOW_SIZE,timeWindowUnit:timeWindowUnit!==null&&timeWindowUnit!==void 0?timeWindowUnit:DEFAULT_VALUES.TIME_WINDOW_UNIT,groupBy:groupBy!==null&&groupBy!==void 0?groupBy:DEFAULT_VALUES.GROUP_BY,threshold:threshold!==null&&threshold!==void 0?threshold:DEFAULT_VALUES.THRESHOLD});if(indexArray.length>0){await refreshEsFields(indexArray)}};const refreshEsFields=async indices=>{const currentEsFields=await Object(triggersActionsUi_public_["getFields"])(http,indices);setEsFields(currentEsFields)};Object(external_kbnSharedDeps_React_["useEffect"])(()=>{setDefaultExpressionValues()},[]);return external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_React_["Fragment"],null,hasExpressionErrors?external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_React_["Fragment"],null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiSpacer"],null),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiCallOut"],{color:"danger",size:"s",title:expressionErrorMessage}),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiSpacer"],null)):null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiTitle"],{size:"xs"},external_kbnSharedDeps_React_default.a.createElement("h5",null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"xpack.stackAlerts.threshold.ui.selectIndex",defaultMessage:"Select an index"}))),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiSpacer"],{size:"s"}),external_kbnSharedDeps_React_default.a.createElement(index_select_popover["a"],{index:indexArray,"data-test-subj":"indexSelectPopover",esFields:esFields,timeField:timeField,errors:errors,onIndexChange:async indices=>{setAlertParams("index",indices);if(indices.length===0){setAlertProperty("params",{...alertParams,index:indices,aggType:DEFAULT_VALUES.AGGREGATION_TYPE,termSize:DEFAULT_VALUES.TERM_SIZE,thresholdComparator:DEFAULT_VALUES.THRESHOLD_COMPARATOR,timeWindowSize:DEFAULT_VALUES.TIME_WINDOW_SIZE,timeWindowUnit:DEFAULT_VALUES.TIME_WINDOW_UNIT,groupBy:DEFAULT_VALUES.GROUP_BY,threshold:DEFAULT_VALUES.THRESHOLD,timeField:""})}else{await refreshEsFields(indices)}},onTimeFieldChange:updatedTimeField=>setAlertParams("timeField",updatedTimeField)}),external_kbnSharedDeps_React_default.a.createElement(triggersActionsUi_public_["WhenExpression"],{display:"fullWidth","data-test-subj":"whenExpression",aggType:aggType!==null&&aggType!==void 0?aggType:DEFAULT_VALUES.AGGREGATION_TYPE,onChangeSelectedAggType:selectedAggType=>setAlertParams("aggType",selectedAggType)}),aggType&&triggersActionsUi_public_["builtInAggregationTypes"][aggType].fieldRequired?external_kbnSharedDeps_React_default.a.createElement(triggersActionsUi_public_["OfExpression"],{aggField:aggField,"data-test-subj":"aggTypeExpression",fields:esFields,aggType:aggType,errors:errors,display:"fullWidth",onChangeSelectedAggField:selectedAggField=>setAlertParams("aggField",selectedAggField)}):null,external_kbnSharedDeps_React_default.a.createElement(triggersActionsUi_public_["GroupByExpression"],{groupBy:groupBy||DEFAULT_VALUES.GROUP_BY,"data-test-subj":"groupByExpression",termField:termField,termSize:termSize,errors:errors,fields:esFields,display:"fullWidth",onChangeSelectedGroupBy:selectedGroupBy=>setAlertParams("groupBy",selectedGroupBy),onChangeSelectedTermField:selectedTermField=>setAlertParams("termField",selectedTermField),onChangeSelectedTermSize:selectedTermSize=>setAlertParams("termSize",selectedTermSize)}),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiSpacer"],null),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiTitle"],{size:"xs"},external_kbnSharedDeps_React_default.a.createElement("h5",null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"xpack.stackAlerts.threshold.ui.conditionPrompt",defaultMessage:"Define the condition"}))),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiSpacer"],{size:"s"}),external_kbnSharedDeps_React_default.a.createElement(triggersActionsUi_public_["ThresholdExpression"],{thresholdComparator:thresholdComparator!==null&&thresholdComparator!==void 0?thresholdComparator:DEFAULT_VALUES.THRESHOLD_COMPARATOR,threshold:threshold,"data-test-subj":"thresholdExpression",errors:errors,display:"fullWidth",popupPosition:"upLeft",onChangeSelectedThreshold:selectedThresholds=>setAlertParams("threshold",selectedThresholds),onChangeSelectedThresholdComparator:selectedThresholdComparator=>setAlertParams("thresholdComparator",selectedThresholdComparator)}),external_kbnSharedDeps_React_default.a.createElement(triggersActionsUi_public_["ForLastExpression"],{"data-test-subj":"forLastExpression",popupPosition:"upLeft",timeWindowSize:timeWindowSize!==null&&timeWindowSize!==void 0?timeWindowSize:DEFAULT_VALUES.TIME_WINDOW_SIZE,timeWindowUnit:timeWindowUnit!==null&&timeWindowUnit!==void 0?timeWindowUnit:DEFAULT_VALUES.TIME_WINDOW_UNIT,display:"fullWidth",errors:errors,onChangeWindowSize:selectedWindowSize=>setAlertParams("timeWindowSize",selectedWindowSize),onChangeWindowUnit:selectedWindowUnit=>setAlertParams("timeWindowUnit",selectedWindowUnit)}),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiSpacer"],null),external_kbnSharedDeps_React_default.a.createElement("div",{className:"actAlertVisualization__chart"},cannotShowVisualization?external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_React_["Fragment"],null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiEmptyPrompt"],{"data-test-subj":"visualizationPlaceholder",iconType:"visBarVertical",body:external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiText"],{color:"subdued"},external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"xpack.stackAlerts.threshold.ui.previewAlertVisualizationDescription",defaultMessage:"Complete the expression to generate a preview."}))})):external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_React_["Fragment"],null,external_kbnSharedDeps_React_default.a.createElement(ThresholdVisualization,{"data-test-subj":"thresholdVisualization",alertParams:alertParams,alertInterval:alertInterval,aggregationTypes:triggersActionsUi_public_["builtInAggregationTypes"],comparators:triggersActionsUi_public_["builtInComparators"],charts:charts,dataFieldsFormats:data.fieldFormats}))))}}}]);